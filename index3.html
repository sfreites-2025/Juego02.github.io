<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pac-Man Laberinto Avanzado</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #000;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    user-select: none;
  }
  h1 {
    margin: 20px 0;
    text-shadow: 0 0 5px #0ff;
  }
  #maze {
    display: grid;
    grid-template-columns: repeat(19, 30px);
    grid-template-rows: repeat(21, 30px);
    gap: 2px;
    background-color: #222;
    border: 3px solid #0ff;
    box-shadow: 0 0 12px #0ffaaaff;
    position: relative;
  }
  .cell {
    width: 30px;
    height: 30px;
    box-sizing: border-box;
  }
  .wall {
    background-color: #00008b;
    box-shadow: inset 0 0 5px #0000ff;
  }
  .path {
    background-color: #111;
    position: relative;
  }
  .player {
    background-color: #ffeb3b;
    border-radius: 50%;
    box-shadow: 0 0 15px 3px #ffeb3b, inset 0 0 10px 3px #fff176;
    position: relative;
    z-index: 10;
  }
  .ghost {
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    position: relative;
    z-index: 5;
  }
  .ghost.blinky {
    background-color: #f00;
    box-shadow: 0 0 15px 3px #f00, inset 0 0 10px 3px #ff5252;
  }
  .ghost.pinky {
    background-color: #ff69b4;
    box-shadow: 0 0 15px 3px #ff69b4, inset 0 0 10px 3px #ff85c1;
  }
  .ghost.inky {
    background-color: #00ffff;
    box-shadow: 0 0 15px 3px #00ffff, inset 0 0 10px 3px #66f0f0;
  }
  .ghost.clyde {
    background-color: #ffa500;
    box-shadow: 0 0 15px 3px #ffa500, inset 0 0 10px 3px #ffcf6a;
  }
  .goal {
    background-color: #4caf50;
    border-radius: 50%;
    box-shadow: 0 0 20px 4px #4caf5011, inset 0 0 10px 3px #81c784;
    position: relative;
    z-index: 1;
  }
  .pill {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 12px;
    height: 12px;
    background-color: #fff59d;
    border-radius: 50%;
    box-shadow: 0 0 8px 1.5px #fff59d;
    transform: translate(-50%, -50%);
    z-index: 1;
  }
  #info {
    margin: 15px;
    font-size: 18px;
    text-shadow: 0 0 5px #0ff;
  }
</style>
</head>
<body>

<h1>Pac-Man Laberinto Avanzado</h1>
<div id="maze"></div>
<div id="info">
  Movimientos: <span id="moves">0</span> |
  Pastillas: <span id="pills">0</span>/7
</div>

<script>
  // Configuración inicial
  const mazeElement = document.getElementById('maze');
  const movesCounter = document.getElementById('moves');
  const pillsCounter = document.getElementById('pills');

  const mazeMapOriginal = [
    [1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1],
    [1,2,0,0,1,0,0,0,1,4,1,0,0,0,1,0,0,3,1],
    [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
    [0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,1,0,0],
    [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
    [1,0,0,0,0,5,0,0,0,0,0,0,0,6,0,0,0,7,1],
    [1,0,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,0,1],
    [1,0,0,0,1,0,0,0,1,0,1,0,0,0,1,0,0,0,1],
    [1,1,1,0,1,1,1,0,1,0,1,0,1,1,1,0,1,1,1],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1],
    [1,0,0,0,1,0,0,0,1,0,1,0,0,0,1,0,0,0,1],
    [0,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,0],
    [1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],
    [1,1,1,1,1,0,1,0,1,1,1,0,1,0,1,1,1,1,1],
    [1,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,0,1],
    [1,0,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,0,1],
    [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,0,0,1,1,1,1,1,1,1,0,1,1,1,0,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1],
  ];

  const rows = mazeMapOriginal.length;
  const cols = mazeMapOriginal[0].length;

  let mazeMap = []; // Copia dinámica del mapa para modificar
  let playerPosition = { x:0, y:0 };
  let moves = 0;
  let pillsCollected = 0;

  // Fantasmas con posición, tipo y dirección
  let ghosts = [
    {x:0, y:0, dx:0, dy:0, type: 'blinky'}, // rojo
    {x:0, y:0, dx:0, dy:0, type: 'pinky'},  // rosa
    {x:0, y:0, dx:0, dy:0, type: 'inky'},   // azul
    {x:0, y:0, dx:0, dy:0, type: 'clyde'}   // naranja
  ];

  let playerStartPositions = [];
  let ghostsInitPos = [];

  // Proporciona las posiciones iniciales para el respawn
  function scanMapForPositions() {
    playerStartPositions = [];
    ghostsInitPos = [];
    mazeMap = JSON.parse(JSON.stringify(mazeMapOriginal));
    for(let y=0; y<rows; y++){
      for(let x=0; x<cols; x++){
        const cell = mazeMap[y][x];
        if(cell === 2){
          playerStartPositions.push({x, y});
          mazeMap[y][x] = 0;
          playerPosition = {x, y};
        }
        if(cell >= 5 && cell <= 8){
          ghostsInitPos[cell - 5] = {x, y};
          mazeMap[y][x] = 0;
        }
      }
    }
  }

  // Pastillas dinámicas
  const totalPills = 7;
  let pillsOnMap = new Set();

  // Añade las pastillas iniciales a posiciones aleatorias válidas (no muros, ni player/ghosts)
  function fillInitialPills(){
    pillsOnMap.clear();
    let count = 0;
    while(count < totalPills){
      const x = Math.floor(Math.random() * cols);
      const y = Math.floor(Math.random() * rows);
      if(mazeMap[y][x] === 0 && !pillsOnMap.has(`${x},${y}`) &&
          !(playerPosition.x === x && playerPosition.y === y) &&
          !ghosts.some(g => g.x === x && g.y === y)){
        pillsOnMap.add(`${x},${y}`);
        count++;
      }
    }
  }

  // Construye el grid visual del laberinto con celdas y elementos
  function createMaze() {
    mazeElement.style.gridTemplateColumns = `repeat(${cols}, 30px)`;
    mazeElement.style.gridTemplateRows = `repeat(${rows}, 30px)`;
    mazeElement.innerHTML = '';

    for (let y=0; y<rows; y++) {
      for (let x=0; x<cols; x++) {
        const cellDiv = document.createElement('div');
        cellDiv.classList.add('cell');

        if(mazeMap[y][x] === 1){
          cellDiv.classList.add('wall');
        } else {
          cellDiv.classList.add('path');
          if(pillsOnMap.has(`${x},${y}`)){
            const pillEl = document.createElement('div');
            pillEl.classList.add('pill');
            cellDiv.appendChild(pillEl);
          }
          if(mazeMap[y][x] === 3){
            cellDiv.classList.add('goal');
          }
        }
        cellDiv.id = `cell-${x}-${y}`;
        mazeElement.appendChild(cellDiv);
      }
    }
    drawPlayer();
    drawGhosts();
    updatePillsCounter();
  }

  // Actualiza la posición del jugador visualmente
  function drawPlayer(){
    document.querySelectorAll('.player').forEach(el => el.classList.remove('player'));
    const cell = document.getElementById(`cell-${playerPosition.x}-${playerPosition.y}`);
    if(cell) cell.classList.add('player');
  }

  // Actualiza la posición de los fantasmas visualmente
  function drawGhosts(){
    document.querySelectorAll('.ghost').forEach(el => el.classList.remove('ghost', 'blinky', 'pinky', 'inky', 'clyde'));
    ghosts.forEach((g) => {
      const cell = document.getElementById(`cell-${g.x}-${g.y}`);
      if(cell){
        cell.classList.add('ghost', g.type);
      }
    });
  }

  function updatePillsCounter(){
    pillsCounter.textContent = pillsCollected;
  }

  // Movimiento jugador con wrap-around
  function movePlayer(dx, dy){
    const newX = (playerPosition.x + dx + cols) % cols;
    const newY = (playerPosition.y + dy + rows) % rows;

    if (mazeMap[newY][newX] === 1) return;

    playerPosition.x = newX;
    playerPosition.y = newY;

    checkPillCollection(newX, newY);
    
    moves++;
    movesCounter.textContent = moves;

    drawPlayer();
    checkGhostCollision();
    checkGoal();
  }

  // Recolectar pastilla, quitarla y crear otra aleatoriamente
  function checkPillCollection(x,y){
    const key = `${x},${y}`;
    if(pillsOnMap.has(key)){
      pillsOnMap.delete(key);
      pillsCollected++;
      updatePillsCounter();
      removePillVisual(x,y);
      spawnRandomPill();
    }
  }

  function removePillVisual(x,y){
    const cell = document.getElementById(`cell-${x}-${y}`);
    if(cell){
      const pill = cell.querySelector('.pill');
      if(pill) cell.removeChild(pill);
    }
  }

  function spawnRandomPill(){
    const emptySpaces = [];
    for(let y=0; y<rows; y++){
      for(let x=0; x<cols; x++){
        if(mazeMap[y][x] === 0 && !pillsOnMap.has(`${x},${y}`) &&
           !(playerPosition.x===x && playerPosition.y===y) &&
           !ghosts.some(g=>g.x===x && g.y===y)){
          emptySpaces.push({x,y});
        }
      }
    }
    if(emptySpaces.length){
      const index = Math.floor(Math.random()*emptySpaces.length);
      const pos = emptySpaces[index];
      pillsOnMap.add(`${pos.x},${pos.y}`);
      const cell = document.getElementById(`cell-${pos.x}-${pos.y}`);
      if(cell){
        const pill = document.createElement('div');
        pill.classList.add('pill');
        cell.appendChild(pill);
      }
    }
  }

  // Algoritmos IA fantasmas y movimiento
  function manhattanDist(p1, p2){
    const dx = Math.min(Math.abs(p1.x - p2.x), cols - Math.abs(p1.x - p2.x));
    const dy = Math.min(Math.abs(p1.y - p2.y), rows - Math.abs(p1.y - p2.y));
    return dx + dy;
  }

  function ghostMoveTowards(ghost, target){
    const moves = [
      {dx: 1, dy: 0},
      {dx:-1, dy: 0},
      {dx: 0, dy: 1},
      {dx: 0, dy:-1}
    ];
    const legalMoves = moves.filter(m => {
      const nx = (ghost.x + m.dx + cols) % cols;
      const ny = (ghost.y + m.dy + rows) % rows;
      return mazeMap[ny][nx] !==1;
    });
    if(legalMoves.length===0) return;
    legalMoves.sort((a,b) => {
      const ax = (ghost.x + a.dx + cols) % cols;
      const ay = (ghost.y + a.dy + rows) % rows;
      const bx = (ghost.x + b.dx + cols) % cols;
      const by = (ghost.y + b.dy + rows) % rows;
      return manhattanDist({x:ax,y:ay},target) - manhattanDist({x:bx,y:by},target);
    });
    ghost.x = (ghost.x + legalMoves[0].dx + cols) % cols;
    ghost.y = (ghost.y + legalMoves[0].dy + rows) % rows;
  }

  function predictPosition(player, steps){
    const x = (player.x + steps + cols) % cols;
    const y = player.y;
    if(mazeMap[y][x] === 1) return {...player};
    return {x, y};
  }

  function inkyTarget(blinky, player){
    if(!blinky) return {...player};
    let px = (player.x + 0 + cols) % cols;
    let py = (player.y - 2 + rows) % rows;
    let vx = px - blinky.x;
    let vy = py - blinky.y;
    let tx = (blinky.x + vx*2 + cols) % cols;
    let ty = (blinky.y + vy*2 + rows) % rows;
    if(mazeMap[ty][tx] === 1) return {...player};
    return {x:tx, y:ty};
  }

  function clydeTarget(clyde, player){
    const dist = manhattanDist(clyde, player);
    if(dist > 8) return {...player};
    return {x:0, y:rows-1};
  }

  // Ejecutar movimientos fantasmas según patrón
  function moveGhosts(){
    ghosts.forEach(g=>{
      let target;
      switch(g.type){
        case 'blinky': target = {...playerPosition}; break;
        case 'pinky': target = predictPosition(playerPosition, 4); break;
        case 'inky':
          const blinky = ghosts.find(f=>f.type==='blinky');
          target = inkyTarget(blinky, playerPosition);
          break;
        case 'clyde': target = clydeTarget(g, playerPosition); break;
      }
      ghostMoveTowards(g, target);
    });
    drawGhosts();
    checkGhostCollision();
  }

  function checkGhostCollision(){
    for(const g of ghosts){
      if(g.x === playerPosition.x && g.y === playerPosition.y){
        alert('¡Fantasma atrapó! Jugador reposicionado.');
        resetPlayerPosition();
      }
    }
  }

  // Mover jugador a posición aleatoria segura distinta de la actual
  function resetPlayerPosition(){
    const openSpaces = [];
    for(let y=0; y<rows; y++){
      for(let x=0; x<cols; x++){
        if(mazeMap[y][x] === 0 && !ghosts.some(g=>g.x===x && g.y===y)){
          openSpaces.push({x,y});
        }
      }
    }
    const safeSpaces = openSpaces.filter(pos => !(pos.x===playerPosition.x && pos.y===playerPosition.y));
    if(safeSpaces.length){
      const newPos = safeSpaces[Math.floor(Math.random()*safeSpaces.length)];
      playerPosition = newPos;
      drawPlayer();
    }
  }

  function checkGoal(){
    if(mazeMap[playerPosition.y][playerPosition.x] === 3){
      if(pillsCollected >= totalPills){
        alert(`¡Felicidades! Ganaste en ${moves} movimientos.`);
        resetGame();
      } else {
        alert(`Debes recolectar las 7 pastillas para ganar.\nPastillas recogidas: ${pillsCollected}`);
      }
    }
  }

  // Reiniciar todo el juego
  function resetGame(){
    moves = 0;
    movesCounter.textContent = moves;
    pillsCollected = 0;
    updatePillsCounter();
    scanMapForPositions();
    fillInitialPills();
    createMaze();
  }

  // Iniciar juego
  scanMapForPositions();
  fillInitialPills();
  createMaze();

  window.addEventListener('keydown', e => {
    switch(e.key){
      case 'ArrowUp': e.preventDefault(); movePlayer(0,-1); break;
      case 'ArrowDown': e.preventDefault(); movePlayer(0,1); break;
      case 'ArrowLeft': e.preventDefault(); movePlayer(-1,0); break;
      case 'ArrowRight': e.preventDefault(); movePlayer(1,0); break;
    }
  });

  // Movimiento fantasmas cada 600ms
  setInterval(moveGhosts, 600);

</script>

</body>
</html>
